const PDQGetCookie=t=>{let e=t+"=",n=decodeURIComponent(document.cookie).split(";");for(let t=0;t<n.length;t++){let r=n[t];for(;" "===r.charAt(0);)r=r.substring(1);if(0===r.indexOf(e))return r.substring(e.length,r.length)}return""};let shopifyWindow,sentryScope,PDQ_API_URL="checkout-service.pdq.team",SHOP_PLUGIN_API_URL="ecommerce-plugin.pdqprod.link",SENTRY_DSN="https://9d94da7524fa78a07c5cc59429c85d01@o4507333300387840.ingest.us.sentry.io/4507407023144960",environment="production",enableLog=!1,isProductPromiseTagFound=!1,sentryInitialized=!1;const PDQ_PRODUCT_PROMISE_TAG="PDQProductPromise",PDQ_PROPERTY_NAME="__pdqId",PDQ_PROPERTY_NAME_SUBSCRIPTION="__subscription",SUCCESS_STATUS=200,XML_DONE_READY_STATE=4,CART_PAGE_URL="/cart",getPdqSessionToken=()=>{const t=PDQGetCookie("cart");return t?.includes("?key=")?t.split("?key=")[0]:t};class pdqLog{constructor(){}log=t=>{enableLog&&console.log(t)};error=t=>{enableLog&&console.error("Error",t)}}function turnOnLogs(t){enableLog=t}function initSentry(){if(!environment.includes("anchor")&&!SENTRY_DSN.includes("anchor")&&!sentryInitialized)try{if(!sentryInitialized){const t=document.createElement("script");t.src="https://browser.sentry-cdn.com/8.9.2/bundle.min.js",t.setAttribute("crossorigin","anonymous"),t.setAttribute("integrity","sha384-V1L2j6P9YYFgSbGOSSHVfHQZBNv2a1JK5HXDTg6a6IILWj4Rde0tZxsXOrwWD6ll"),document.head.appendChild(t),sentryInitialized=!0,t.onload=()=>{const t=SENTRY_DSN,e=new Sentry.BrowserClient({dsn:t,transport:Sentry.makeFetchTransport,stackParser:Sentry.defaultStackParser,integrations:[Sentry.breadcrumbsIntegration(),Sentry.browserTracingIntegration()],environment:environment,tunnel:`https://${PDQ_API_URL}/sentry-tunnel`}),n=new Sentry.Scope;n.setClient(e),e.init(),sentryScope=n,sentryScope.setTag("script","shopify-scripts.js"),sentryScope.setTag("shop",shopifyWindow?.Shopify?.shop??"unknown-shop")}}}catch(t){console.error("Failed to init sentry",t)}}const pdqInternalLogger=new pdqLog;function initFormCartProperties(){const t=document.createElement("input");t.setAttribute("type","hidden"),t.setAttribute("name",`properties[${PDQ_PROPERTY_NAME}]`),t.setAttribute("value",getPdqSessionToken());const e=()=>{document.querySelectorAll("form[action='/cart/add']").forEach((e=>{e.appendChild(t)}))};"complete"===this.document.readyState?(pdqInternalLogger.log("Dom ready state complete, pdq"),e()):document.addEventListener("DOMContentLoaded",(function(){pdqInternalLogger.log("Dom content loaded, pdq"),e()}))}function removePropertiesFromDOMCartPage(){try{const t=document.querySelectorAll("div");for(let e=0;e<t.length;e++)if(t[e].innerHTML?.trim().startsWith("__pdqId")){const n=t[e].innerText.replace(/^__pdqId:(.*)/,"");t[e].innerText=n}}catch(t){}}function initCartPropertiesScript(){try{const r=t=>{const e=t;try{if("string"==typeof t){const e=decodeURIComponent(t);if(e&&e.includes("items[0]["))throw new Error("not support add items on formdata array")}const e="string"==typeof t&&t.split("&");if(e?.length>1)return!t.includes(`${PDQ_PROPERTY_NAME}`)&&t?.length&&(e.push(`properties[${PDQ_PROPERTY_NAME}]=${getPdqSessionToken()}`),t=e.join("&")),t;if(o(t)){const e=JSON.parse(t);return e?.items?.length?(e.items.forEach((t=>{t.properties={...t?.properties??{},[PDQ_PROPERTY_NAME]:getPdqSessionToken()}})),t=JSON.stringify(e)):e?(e.properties={...e.properties??{},[PDQ_PROPERTY_NAME]:getPdqSessionToken()},t=JSON.stringify(e)):t}return t}catch(t){return sentryScope&&!["not support add items on formdata array"].includes(t?.message)&&sentryScope.captureException(t),{originalData:e,status:"failed"}}},i=t=>{const e=/=\d{3,}/,n=shopifyWindow.location?.search??"";if(n?.includes("selling_plan=")&&e.test(n))return!0;if("string"==typeof t){const n=t.split("&");if(n?.length){return n.some((t=>t.includes("selling_plan=")&&e.test(t)))}}return!1};e=XMLHttpRequest.prototype.send,n=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(t,e,...r){return this.method=t,this.url=e,n.call(this,t,e,...r)},XMLHttpRequest.prototype.send=function(t){try{const e=getPdqSessionToken(),n=this.url?.includes("cart/add"),i="POST"===this.method,o=this.url?.includes("cart.js"),s="GET"===this.method,c=shopifyWindow.location?.href?.includes(CART_PAGE_URL);let p=!1;if(n&&i){if(e){const e=r(t);e&&"object"==typeof e&&"failed"===e.status?(p=!0,t=e.originalData):t=e}this.onreadystatechange=async function(){if(this.readyState===XML_DONE_READY_STATE&&this.status===SUCCESS_STATUS)try{e&&!p||await pdqUpdateCart({[PDQ_PROPERTY_NAME]:getPdqSessionToken()})}catch(t){}}}o&&s&&c&&(this.onreadystatechange=async function(){if(this.readyState===XML_DONE_READY_STATE&&this.status===SUCCESS_STATUS&&this.response){const t=this.response;try{let t;t=JSON.parse(this.response),t.items?.length&&t.items.forEach((t=>{t.properties&&t.properties[PDQ_PROPERTY_NAME]&&delete t.properties[PDQ_PROPERTY_NAME]})),this.response=JSON.stringify(t)}catch(e){this.response=t}}})}catch(n){return e.call(this,t)}return e.call(this,t)};const o=t=>{try{return JSON.parse(t),!0}catch(t){return!1}},s=t=>{let e;try{if("string"!=typeof t||o(t))"string"==typeof t?e=c(t):("function"!=typeof t.get||t?.get(`properties[${PDQ_PROPERTY_NAME}]`)||t.append(`properties[${PDQ_PROPERTY_NAME}]`,getPdqSessionToken()),e=t);else{const n=t.split("&");e=t,n?.length>1&&(!t.includes(`${PDQ_PROPERTY_NAME}`)&&n?.length&&n.push(`properties[${PDQ_PROPERTY_NAME}]=${getPdqSessionToken()}`),i(t)&&n.push(`properties[${PDQ_PROPERTY_NAME_SUBSCRIPTION}]=true`),e=n.join("&"))}return e}catch(e){return sentryScope&&sentryScope.captureException(e),t}},c=t=>{try{const e=getPdqSessionToken(),n=JSON.parse(t);if(n?.items?.length){for(let t=0;t<n.items.length;t++){let r={[PDQ_PROPERTY_NAME]:e};n.items[t]&&n.items[t].properties?n.items[t].properties[PDQ_PROPERTY_NAME]=e:n.items[t]={...n.items[t],properties:r}}return JSON.stringify(n)}if(n?.id){const t=n?.properties;return n.properties=t??{},n.properties[PDQ_PROPERTY_NAME]=e,JSON.stringify(n)}return t}catch(e){return sentryScope&&sentryScope.captureException(e),t}},p=t=>{try{if("string"!=typeof t||o(t)){if("string"==typeof t&&o(t)){const e=JSON.parse(t);return e?.selling_plan?(e.properties||(e.properties={}),e.properties[PDQ_PROPERTY_NAME_SUBSCRIPTION]=!0,JSON.stringify(e)):(e.properties&&e.properties[PDQ_PROPERTY_NAME_SUBSCRIPTION]&&delete e.properties[PDQ_PROPERTY_NAME_SUBSCRIPTION],JSON.stringify(e))}}else{let e=t.split("&");if(e?.length>1){if(!t.includes(`${PDQ_PROPERTY_NAME_SUBSCRIPTION}`)&&i(t))e.push(`properties[${PDQ_PROPERTY_NAME_SUBSCRIPTION}]=true`);else{const t=e.findIndex((t=>t.includes(`${PDQ_PROPERTY_NAME_SUBSCRIPTION}`)));t>=0&&e.splice(t,1)}return e.join("&")}}return t}catch(e){return sentryScope&&sentryScope.captureException(e),t}};t=window.fetch,window.fetch=async(...e)=>{try{const n="string"==typeof e[0]&&e[0]?.includes("cart/add"),r="string"==typeof e[0]&&e[0]?.includes("cart/change"),i=e[1]&&"POST"===e[1]?.method,o=e[1]?.body;if(n&&i){const r=getPdqSessionToken();let i=!1;if(r&&"undefined"!==r){const t=s(o);"string"!=typeof t||t.includes(PDQ_PROPERTY_NAME)||(i=!0),!i&&t&&(e[1].body=t)}else i=!0;const c=await t(...e);try{n&&c.status===SUCCESS_STATUS&&i&&await pdqUpdateCart({[PDQ_PROPERTY_NAME]:getPdqSessionToken()})}catch(t){return c}return c}return i&&r?(e[1].body=p(o),await t(...e)):await t(...e)}catch(n){return await t(...e)}}}catch(t){pdqInternalLogger.error("Failed to use properties script for cart",t)}var t,e,n}async function initCartScript(){await pdqUpdateCart({[PDQ_PROPERTY_NAME]:getPdqSessionToken()}),initCartPropertiesScript(),initFormCartProperties(),removePropertiesFromDOMCartPage(),console.log("initial pdq script")}function initProductPromiseScript(){if(document.getElementsByTagName(PDQ_PRODUCT_PROMISE_TAG)[0]&&!isProductPromiseTagFound)try{const t=document.createElement("script");t.src=`https://${SHOP_PLUGIN_API_URL}/static/js/main.js`;const e=document.createElement("link");e.href=`https://${SHOP_PLUGIN_API_URL}/static/css/main.css`,e.rel="stylesheet",document.head.appendChild(t),document.head.appendChild(e),isProductPromiseTagFound=!0}catch(t){console.log(t)}}async function initPDQscript(){try{shopifyWindow=this,initSentry(),initCartScript(),initProductPromiseScript()}catch(t){console.error("Failed to init pdq script",t)}}async function pdqGetCart(){try{return(await fetch("/cart.json",{method:"POST"})).json()}catch(t){}}async function pdqUpdateCart(t){try{const e=Object.keys(t),n=await pdqGetCart();if(n?.items?.length){const r=n.items;for(let n=0;n<r.length;n++){const i=r[n].properties??{};if(e.some((e=>i[e]!==t[e]))){const e={id:r[n].key,quantity:r[n].quantity,properties:{...r[n].properties,...t}};await fetch("/cart/change.js",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})}}}}catch(t){pdqInternalLogger.log("Error on update cart properties",t)}}"complete"===document.readyState?(initSentry(),initProductPromiseScript()):document.addEventListener("DOMContentLoaded",(function(){initSentry(),initProductPromiseScript()})),initPDQscript();